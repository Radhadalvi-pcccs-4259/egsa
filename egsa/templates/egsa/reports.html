{% extends 'egsa/base.html' %}

{% block title %}Reports - EGSA{% endblock %}

{% block page_title %}
<i class="fas fa-chart-bar text-primary"></i>
Utility Reports
{% endblock %}

{% block content %}
<div class="row">
    <!-- Report Generation -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>Generate Report
                </h5>
            </div>
            <div class="card-body">
                <form method="get">
                    <div class="mb-3">
                        <label for="month" class="form-label">Month</label>
                        <select class="form-select" id="month" name="month">
                            {% for i in "123456789ABC"|make_list %}
                            <option value="{{ forloop.counter }}" {% if month == forloop.counter %}selected{% endif %}>
                                {% if forloop.counter == 1 %}January{% elif forloop.counter == 2 %}February{% elif forloop.counter == 3 %}March{% elif forloop.counter == 4 %}April{% elif forloop.counter == 5 %}May{% elif forloop.counter == 6 %}June{% elif forloop.counter == 7 %}July{% elif forloop.counter == 8 %}August{% elif forloop.counter == 9 %}September{% elif forloop.counter == 10 %}October{% elif forloop.counter == 11 %}November{% else %}December{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="year" class="form-label">Year</label>
                        <select class="form-select" id="year" name="year">
                            <option value="2023" {% if year == 2023 %}selected{% endif %}>2023</option>
                            <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
                            <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
                            <option value="2026" {% if year == 2026 %}selected{% endif %}>2026</option>
                        </select>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-chart-line me-2"></i>Generate Report
                        </button>
                    </div>
                </form>
                
                <hr>
                
                <h6>Report Features:</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success me-2"></i>Cost Analysis</li>
                    <li><i class="fas fa-check text-success me-2"></i>Efficiency Ratings</li>
                    <li><i class="fas fa-check text-success me-2"></i>Usage Recommendations</li>
                    <li><i class="fas fa-check text-success me-2"></i>AWS S3 Storage</li>
                    <li><i class="fas fa-check text-success me-2"></i>Email Delivery</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Current Report -->
    <div class="col-lg-8">
        {% if analysis %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Report for {{ year }}-{{ month|stringformat:"02d" }}
                </h5>
                <span class="badge bg-primary">{{ readings_count }} readings</span>
            </div>
            <div class="card-body">
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3>${{ analysis.total_cost|floatformat:2 }}</h3>
                                <small>Total Cost</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3>{{ analysis.efficiency_scores|length }}</h3>
                                <small>Utilities Tracked</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3>
                                    {% with analysis.efficiency_scores.values as scores %}
                                    {% for score in scores %}
                                    {% if score == "Excellent" or score == "Good" %}+{% endif %}
                                    {% endfor %}
                                    {% endwith %}
                                </h3>
                                <small>Good+ Ratings</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Efficiency Scores -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Efficiency Ratings</h6>
                        {% for utility, score in analysis.efficiency_scores.items %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                {% if utility == 'electricity' %}
                                    <i class="fas fa-bolt text-warning me-2"></i>
                                {% elif utility == 'gas' %}
                                    <i class="fas fa-fire text-danger me-2"></i>
                                {% elif utility == 'steam' %}
                                    <i class="fas fa-cloud text-secondary me-2"></i>
                                {% elif utility == 'air_conditioning' %}
                                    <i class="fas fa-snowflake text-info me-2"></i>
                                {% endif %}
                                <strong>{{ utility|title }}</strong>
                            </div>
                            <span class="badge bg-{% if score == 'Excellent' %}success{% elif score == 'Good' %}info{% elif score == 'Average' %}warning{% else %}danger{% endif %} fs-6">
                                {{ score }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Recommendations -->
                {% if analysis.recommendations %}
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Recommendations</h6>
                        <div class="alert alert-info">
                            <ul class="mb-0">
                                {% for recommendation in analysis.recommendations %}
                                <li>{{ recommendation }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Environmental Impact -->
                {% if analysis.environmental_impact.co2_kg %}
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Environmental Impact</h6>
                        <div class="alert alert-success">
                            <i class="fas fa-leaf me-2"></i>
                            <strong>Carbon Footprint:</strong> {{ analysis.environmental_impact.co2_kg|floatformat:2 }} kg COâ‚‚
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Report Content Preview -->
                <div class="row">
                    <div class="col-12">
                        <h6>Report Content Preview</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <pre class="mb-0 small">{{ report_content }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5>No Report Generated</h5>
                <p class="text-muted">Select a month and year to generate your utility report</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Previous Reports -->
{% if previous_reports %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Previous Reports
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Report Name</th>
                                <th>Type</th>
                                <th>Generated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in previous_reports %}
                            <tr>
                                <td>
                                    <i class="fas fa-file-alt text-primary me-2"></i>
                                    {{ report.report_name }}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ report.report_type|title }}</span>
                                </td>
                                <td>{{ report.date_generated|date:"M d, Y g:i A" }}</td>
                                <td>
                                    <a href="{% url 'download_report' report.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download me-1"></i>Download
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- AWS Integration Status -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fab fa-aws text-warning me-2"></i>AWS Integration Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fab fa-aws text-warning me-2"></i>
                                <strong>S3 Storage:</strong> Reports saved to cloud
                            </div>
                            <span class="badge bg-success">Active</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-envelope text-info me-2"></i>
                                <strong>SES Email:</strong> Reports sent via email
                            </div>
                            <span class="badge bg-success">Enabled</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-chart-line text-secondary me-2"></i>
                                <strong>CloudWatch:</strong> Logging & monitoring
                            </div>
                            <span class="badge bg-success">Active</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-calculator text-primary me-2"></i>
                                <strong>EGSA Calculator:</strong> Advanced analysis
                            </div>
                            <span class="badge bg-success">Running</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-update year to current year
document.addEventListener('DOMContentLoaded', function() {
    const currentYear = new Date().getFullYear();
    const yearSelect = document.getElementById('year');
    
    // Add current year option if not present
    let yearExists = false;
    for (let option of yearSelect.options) {
        if (option.value == currentYear) {
            yearExists = true;
            break;
        }
    }
    
    if (!yearExists) {
        const newOption = new Option(currentYear, currentYear);
        yearSelect.add(newOption);
    }
});
</script>
{% endblock %}
